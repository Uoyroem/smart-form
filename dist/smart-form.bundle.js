(()=>{"use strict";var e,t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},s={};t.r(s),t.d(s,{Uoyroem:()=>e}),function(e){function t(e,s){if(e===s)return!0;if("object"!=typeof e||"object"!=typeof s||null===e||null===s)return!1;const i=new Set(Object.keys(e)),n=new Set(Object.keys(s));if(i.size!==n.size)return!1;for(const n of i)if(!t(e[n],s[n]))return!1;return!0}function s(e,t){return`${e}.${t}`}e.getMetaDependencyKey=s;class i{constructor(){this._nameEffect=new Map,this._names=new Set,this._dependentMap=new Map,this._dependencyMap=new Map,this._addedDependencies=[],this._nameEffect=new Map,this._names=new Set,this._dependentMap=new Map,this._dependencyMap=new Map,this._addedDependencies=[],this._topologicalOrder=[]}buildDependenciesMap(){this._dependentMap=new Map,this._dependencyMap=new Map,this._names=new Set,this._topologicalOrder=[];const e=[];for(const[t,s]of this._nameEffect)for(const i of s.dependsOn)e.push([t,i]);e.push(...this._addedDependencies);for(const[t,s]of e)this._names.add(t),this._names.add(s),this._dependentMap.has(t)||this._dependentMap.set(t,new Set),this._dependentMap.has(s)||this._dependentMap.set(s,new Set),this._dependencyMap.has(t)||this._dependencyMap.set(t,new Set),this._dependencyMap.has(s)||this._dependencyMap.set(s,new Set),this._dependentMap.get(t).add(s),this._dependencyMap.get(s).add(t);const t=new Map;for(const[e,s]of this._dependentMap)t.set(e,s.size);const s=[];for(const[e,i]of t)0===i&&s.push(e);for(;s.length>0;){const e=s.shift();this._topologicalOrder.push(e);for(const i of this._dependencyMap.get(e))t.set(i,t.get(i)-1),0===t.get(i)&&s.push(i)}this._topologicalOrder.length!==this._names.size?console.error("There are cyclic dependencies."):(console.log("Dependency map successfully built."),console.log(this._topologicalOrder))}addDependency(e,t){this._addedDependencies.push([e,t])}addEffect(e,t){this._nameEffect.set(e,t)}async triggerEffects({changedNames:e=null}={}){null==e?console.group("Triggering all effects"):console.group("Triggering effects for changed names: ",e);for(const t of this._topologicalOrder){if(null!=e&&0===this._dependentMap.get(t).intersection(e).size)continue;console.group("Triggering effect: ",t);const s=this._nameEffect.get(t);if(null!=s){const t=await s.callback();e&&t.forEach((t=>{e.add(t)}))}else e&&(e.add(t),console.log("There were changes"));console.groupEnd()}console.groupEnd()}}e.EffectManager=i,e.FormFieldValidator=class{constructor(e){this.name=e}validate(e){}};class n{static nullable(){return class extends(this){constructor(e){super(e),this._nullable=!1}nullable(e=!0){return this._nullable=e,this}}}static object({nullable:e=!1}={}){return(new u).nullable(e)}static text({nullable:e=!1}={}){return(new a).nullable(e)}static number({nullable:e=!1}={}){return(new l).nullable(e)}static date({nullable:e=!1}={}){return(new r).nullable(e)}static select({multiple:e=!1,nullable:t=!1}={}){return(new h).multiple(e).nullable(t)}static checkbox(){return new c}static radio(){return new d}static isFormElement(e){return e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement}static fromFormElement(e){switch(e.type){case"select-one":return this.select();case"select-multiple":return this.select().multiple();case"number":return this.number();case"text":return this.text();case"textarea":return this.text().area();case"checkbox":return this.checkbox();case"radio":return this.radio();case"date":return this.date();default:throw new Error(`As element type ${e} not has`)}}constructor(e){this.name=e}isEqual(e,t){return e===t}isEmpty(){}asElementType(){return"hidden"}getFieldValue(e){return e.getValue()}setFieldValue(e,t){return e.setValue(t)}initializeValue(e){e(null)}initializeMeta(e){e("disabled",!1),e("dirty",!1)}isSameType(e){return this.name===e.name}}e.FormFieldType=n;class a extends(n.nullable()){constructor(){super("String"),this._area=!1}area(e=!0){return this._area=e,this}asElementType(){return this._area?"textarea":"text"}}e.FormFieldTypeText=a;class l extends(n.nullable()){constructor(){super("Number")}asElementType(){return"number"}}e.FormFieldTypeNumber=l;class r extends(n.nullable()){constructor(){super("Date")}asElementType(){return"date"}isEqual(e,t){return e.toDateString()===t.toDateString()}}e.FormFieldTypeDate=r;class d extends n{constructor(){super("Radio")}asElementType(){return"radio"}initializeMeta(e){super.initializeMeta(e),e("checked",!0)}getFieldValue(e){return e.getMetaValue("checked")?e.getValue():null}setFieldValue(e,t){return e.setMetaValue("checked",null!=t&&t===e.getValue())}}e.FormFieldTypeRadio=d;class c extends n{constructor(){super("Checkbox")}asElementType(){return"checkbox"}initializeMeta(e){super.initializeMeta(e),e("checked",!0)}getFieldValue(e){const t=e.getValue();return["","on"].includes(t)?e.getMetaValue("checked"):e.getMetaValue("checked")?t:null}setFieldValue(e,t){return["","on"].includes(e.getValue())?e.setMetaValue("checked",t):e.setValue(t)}}e.FormFieldTypeCheckbox=c;class h extends(n.nullable()){constructor(){super("select"),this._multiple=!1,this._of=n.text()}asElementType(){return this._multiple?"select-multiple":"select-one"}initializeMeta(e){super.initializeMeta(e),e("optionsInitialized",!1)}multiple(e=!0){return this._multiple=e,this}of(e){return this._of=e,this}}e.FormFieldTypeSelect=h;class u extends(n.nullable()){constructor(){super("Object")}isEqual(e,s){return t(e,s)}}let o;e.FormFieldTypeObject=u,function(e){e.VALUE="value",e.METAVALUE="metavalue"}(o=e.ChangeType||(e.ChangeType={}));class p extends Event{constructor(e){super("changes",{cancelable:!0}),this.changes=e}}e.ChangesEvent=p;class f{constructor(e=128){this._changes=[],this._maxSize=e}add(e){if(this._changes.push(e),console.log("[FieldChangeSet] Change",e,"added"),this._changes.length>this._maxSize){const e=this._changes.findIndex((e=>e.processed));-1!==e&&this._changes.splice(e,1)}}remove(e){this._changes.splice(this._changes.indexOf(e),1)}findLast(e){return this._changes.find((t=>t.last&&e(t)))}getFieldChanges(e){return this._changes.filter((t=>!t.processed&&t.field===e))}getLastFieldChanges(e){return this._changes.filter((t=>!t.processed&&t.last&&t.field===e))}hasChanges(e){return 0!==this.getLastFieldChanges(e).length}markProcessed(e){e.forEach((e=>{e.processed=!0}))}static asChangedName(e){return"value"===e.type?e.field.name:"metavalue"===e.type?s(e.field.name,e.metaKey):null}static asChangedNames(e){const t=new Set;for(const s of e){const e=this.asChangedName(s);null!=e&&t.add(e)}return t}processChanges(e){const t=this.getFieldChanges(e),s=this.getLastFieldChanges(e);return this.markProcessed(t),e.dispatchEvent(new p(t)),f.asChangedNames(s)}}e.FormFieldChangeSet=f;class g extends EventTarget{constructor(e,t,{changeSet:s=null,effectManager:i=null}={}){super(),this.name=e,this.type=t,this._initializedStateKeys=new Set,this._currentStateKey="default",this._initialValue=null,this.initialValue((e=>t.initializeValue(e))),this._valueMap=new Map,this._initialMeta=new Map,this.initialMeta((e=>t.initializeMeta(e)),!1),this._metaMap=new Map,this.changeSet=s??new f(32),this.switchState("default"),null!=i&&this.initializeDependencies(i)}initialValue(e){e((e=>{this._initialValue=e}))}initialMeta(e,t=!1){t&&(this._initialMeta=new Map),e(((e,t)=>{this._initialMeta.set(e,t)}))}reset({stateKey:e=null,initiator:t=null}={}){e??(e=this._currentStateKey),this._valueMap.set(e,null),this._metaMap.set(e,new Map),this.setValue(this._initialValue,{stateKey:e,initiator:t,typed:!1});for(const[s,i]of this._initialMeta.entries())this.setMetaValue(s,i,{stateKey:e,initiator:t});return this.processChanges()}switchState(e){this._initializedStateKeys.has(e)||(this._initializedStateKeys.add(e),this.reset({stateKey:e})),this._currentStateKey=e}initializeDependencies(e){switch(e.addDependency(this.name,s(this.name,"disabled")),this.type.asElementType()){case"checkbox":case"radio":e.addDependency(this.name,s(this.name,"checked"))}}getAdapter({stateKey:e=null,initiator:t=null,disabledIsNull:s=!0,typed:i=!0}={}){const n=e,a=t,l=i,r=s;return new Proxy(this,{get(e,t,s){switch(t){case"getValue":return({stateKey:t=n,typed:s=l,disabledIsNull:i=r}={})=>e.getValue({typed:s,stateKey:t,disabledIsNull:i});case"getMetaValue":return(t,{stateKey:s=n}={})=>e.getMetaValue(t,{stateKey:s});case"setValue":return(t,{stateKey:s=n,typed:i=l,initiator:r=a,processChanges:d=!1}={})=>e.setValue(t,{stateKey:s,typed:i,initiator:r,processChanges:d});case"setMetaValue":return(t,s,{stateKey:i=n,initiator:l=a,processChanges:r=!1}={})=>e.setMetaValue(t,s,{stateKey:i,initiator:l,processChanges:r});default:const i=Reflect.get(e,t,s);return"function"==typeof i?i.bind(e):i}}})}getValue({stateKey:e=null,typed:t=!0,disabledIsNull:s=!0}={}){return s&&this.getMetaValue("disabled",{stateKey:e})?null:t?this.type.getFieldValue(this.getAdapter({stateKey:e,disabledIsNull:!1,typed:!1})):this._valueMap.get(e??this._currentStateKey)}setValue(e,{stateKey:t=null,typed:s=!0,initiator:i=null,processChanges:n=!1}={}){if(i??(i=this),t??(t=this._currentStateKey),s)return this.type.setFieldValue(this.getAdapter({stateKey:t,disabledIsNull:!1,typed:!1,initiator:i}),e);const a=this.getValue({stateKey:t,typed:!1});if(this.type.isEqual(a,e))return new Set;this._valueMap.set(t,e);const l=this.changeSet.findLast((e=>"value"===e.type));l&&(l.last=!1);const r={stateKey:t,type:o.VALUE,field:this,initiator:i,oldValue:a,newValue:e,date:new Date,last:!0,processed:!1};return this.changeSet.add(r),n?this.processChanges():f.asChangedNames([r])}getMetaValue(e,{stateKey:t=null}={}){return t??(t=this._currentStateKey),this._metaMap.has(t)?this._metaMap.get(t).get(e):null}setMetaValue(e,t,{stateKey:s=null,initiator:i=null,processChanges:n=!1}={}){if(i??(i=this),s??(s=this._currentStateKey),!this._metaMap.has(s))return new Set;const a=this.getMetaValue(e,{stateKey:s});if(a===t)return new Set;this._metaMap.get(s).set(e,t);const l=this.changeSet.findLast((t=>"metavalue"===t.type&&t.metaKey===e));null!=l&&(l.last=!1),i??(i=this);const r={stateKey:s,type:o.METAVALUE,field:this,initiator:i,metaKey:e,oldValue:a,newValue:t,date:new Date,last:!0,processed:!1};return this.changeSet.add(r),n?this.processChanges():f.asChangedNames([r])}processChanges(){return this.changeSet.processChanges(this)}}e.FormField=g;class m{constructor(e){this.fields=e}getAdapter({stateKey:e=null,initiator:t=null,disabledIsNull:s=!0,typed:i=!0}={}){const n=e,a=t,l=i,r=s;return new Proxy(this,{get(e,t,s){switch(t){case"getValue":return({stateKey:t=n,typed:s=l,disabledIsNull:i=r}={})=>e.getValue({typed:s,stateKey:t,disabledIsNull:i});case"getMetaValue":return(t,{stateKey:s=n}={})=>e.getMetaValue(t,{stateKey:s});case"setValue":return(t,{stateKey:s=n,typed:i=l,initiator:r=a,processChanges:d=!1}={})=>e.setValue(t,{stateKey:s,typed:i,initiator:r,processChanges:d});case"setMetaValue":return(t,s,{stateKey:i=n,initiator:l=a,processChanges:r=!1}={})=>e.setMetaValue(t,s,{stateKey:i,initiator:l,processChanges:r});default:const i=Reflect.get(e,t,s);return"function"==typeof i?i.bind(e):i}}})}getValue({stateKey:e=null,disabledIsNull:t=!0,typed:s=!0}={}){return this.fields.map((i=>i.getValue({stateKey:e,disabledIsNull:t,typed:s}))).find((e=>null!=e))}getMetaValue(e,{stateKey:t=null}={}){return this.fields.map((s=>s.getMetaValue(e,{stateKey:t}))).find((e=>null!=e))}setValue(e,{stateKey:t=null,typed:s=!0,initiator:i=null,processChanges:n=!1}={}){return this.fields.map((a=>a.setValue(e,{stateKey:t,typed:s,initiator:i,processChanges:n}))).find((e=>0!==e.size))??new Set}setMetaValue(e,t,{stateKey:s=null,initiator:i=null,processChanges:n=!1}={}){return this.fields.map((a=>a.setMetaValue(e,t,{stateKey:s,initiator:i,processChanges:n}))).find((e=>0!==e.size))??new Set}processChanges(){return this.fields.map((e=>e.processChanges())).find((e=>0!==e.size))??new Set}}e.FormFieldList=m;class y{constructor(e){this.field=e,this.type=e.type}}e.FormFieldLinker=y;class _ extends y{constructor(e,t){if(super(e),this.element=t,this.type.asElementType()!==this.element.type)throw new Error("For link type is equal");this._fieldChangesEventListener=this._fieldChangesEventListener.bind(this),this._elementValueInputEventListener=this._elementValueInputEventListener.bind(this),this._elementValueChangeEventListener=this._elementValueChangeEventListener.bind(this),this._mutationObserver=new MutationObserver((e=>{for(const t of e)"attributes"===t.type&&"disabled"===t.attributeName&&this.field.setMetaValue("disabled",this.element.disabled)}))}link(){this.field.initialValue((e=>{e(this._getElementValue())})),this.field.initialMeta((e=>{e("disabled",this._getElementMetaValue("disabled")),["radio","checkbox"].includes(this.type.asElementType())&&e("checked",this._getElementMetaValue("checked"))})),this.field.reset(),this.field.addEventListener("changes",this._fieldChangesEventListener),["text","number","textarea"].includes(this.type.asElementType())?this.element.addEventListener("input",this._elementValueInputEventListener):this.element.addEventListener("change",this._elementValueChangeEventListener),this._mutationObserver.observe(this.element,{attributes:!0,attributeFilter:["disabled"]})}unlink(){this.field.removeEventListener("changes",this._fieldChangesEventListener),["text","number","textarea"].includes(this.type.asElementType())?this.element.removeEventListener("input",this._elementValueInputEventListener):this.element.removeEventListener("change",this._elementValueChangeEventListener),this._mutationObserver.disconnect()}_elementValueInputEventListener(e){this.field.setMetaValue("dirty",!0,{initiator:this,processChanges:!0}),this._syncFieldValue()}_elementValueChangeEventListener(e){this.field.setMetaValue("dirty",!0,{initiator:this,processChanges:!0}),["radio","checkbox"].includes(this.type.asElementType())?this._syncFieldMeta("checked"):this._syncFieldValue()}_fieldChangesEventListener(e){const t=e.changes.filter((e=>e.initiator!==this));for(const e of t)e.type===o.VALUE?this._syncElementValue()||this._syncFieldValue():e.type===o.METAVALUE&&this._syncElementMeta(e.metaKey)}_syncElementValue(){const e=this.field.getValue({typed:!1,disabledIsNull:!1}),t=this.field.getMetaValue("optionsInitialized");switch(this.type.asElementType()){case"select-multiple":if(!t)return console.log("PENDING OPTIONS INITIALIZE",e),!0;const s=e.map((e=>this.element.querySelector(`option[value="${e}"]`)));return!s.some((e=>null==e))&&(s.forEach((e=>{e.selected=!0})),!0);case"select-one":if(!t)return console.log("PENDING OPTIONS INITIALIZE",e),!0;const i=this.element.querySelector(`option[value="${e}"]`);return null!=i&&(i.selected=!0,!0)}return this.element.value=e,!0}_getElementValue(){return this.element.value}_syncFieldValue(){this.field.setValue(this._getElementValue(),{typed:!1,initiator:this,processChanges:!0})}_syncElementMeta(e){const t=this.field.getMetaValue(e);switch(e){case"disabled":this.element.disabled=!!t;break;case"checked":this.element.checked=!!t;break;case"visible":const e=this.element.parentElement;null!=e&&(t?(e.style.display="",requestAnimationFrame((()=>{e.dataset.visible="true"}))):(e.addEventListener("transitionend",(t=>{e.style.display="none"}),{once:!0}),e.dataset.visible="false"));break;case"autofill":this.element.classList.toggle("autofill",!!t);break;case"optionsInitialized":console.log("options initialized",!!t),t&&this._syncElementValue()}}_getElementMetaValue(e){switch(e){case"disabled":return this.element.disabled;case"checked":return this.element.checked}}_syncFieldMeta(e){this.field.setMetaValue(e,this._getElementMetaValue(e),{initiator:this,processChanges:!0})}}e.FormFieldElementLinker=_;class M extends EventTarget{constructor(){super(),this.list=[],this._fieldChangesEventListener=this._fieldChangesEventListener.bind(this)}_fieldChangesEventListener(e){const t=e.changes.filter((e=>e.initiator!==this));if(0!==t.length){for(const e of t)if(e.type===o.METAVALUE&&"checked"===e.metaKey&&e.newValue&&"radio"===e.field.type.asElementType()){const t=this.list.find((t=>t.name===e.field.name&&t!==e.field&&t.getMetaValue("checked")));null!=t&&t.setMetaValue("checked",!1,{initiator:this,processChanges:!0})}this.dispatchEvent(new p(t))}}add(e){return!this.list.includes(e)&&(e.addEventListener("changes",this._fieldChangesEventListener),this.list.push(e),!0)}get(e){const t=this.list.filter((t=>t.name===e));return 1===t.length?t[0]:new m(t)}[Symbol.iterator](){return new Set(this.list.map((e=>e.name))).values()}}e.FormFieldsCollection=M;class E extends EventTarget{constructor({form:e}){super(),this.form=e,this.effectManager=new i,this.fields=new M,this.fieldLinkers=[],this.changeSet=new f}async setup(){null!=this.form&&(this.form.classList.add("smart-system-form"),this.form.noValidate=!0,this.form.addEventListener("submit",(e=>{e.preventDefault(),this.submit().then((()=>this.reset()))})),this.form.addEventListener("reset",(e=>{e.preventDefault(),this.reset()})),this.fields.addEventListener("changes",(e=>{const t=f.asChangedNames(e.changes.filter((e=>e.initiator!==this)));0!==t.size&&this.effectManager.triggerEffects({changedNames:t})})),this.registerElements())}getFormData(){const e={};for(const t of this.fields)e[t]=this.fields.get(t).getValue();return e}registerElements(){for(const e of this.form.elements){if(!n.isFormElement(e))continue;if(""===e.name)continue;const t=new g(e.name,n.fromFormElement(e),{changeSet:this.changeSet,effectManager:this.effectManager}),s=new _(t,e);s.link(),this.fieldLinkers.push(s),this.fields.add(t)}}getElement(e){return this.form.elements.namedItem(e)}async validate(){return!0}async submit(){await this.validate()}reset(){for(const e of this.fields.list)e.reset({initiator:this});this.effectManager.triggerEffects()}addDisableWhenEffect(e,t,i){this.effectManager.addEffect(s(e,"disabled"),{type:"disable-when",callback:async()=>{const s=await t();return console.log(`[Effect.DisableWhen] Field ${e} disabled: `,s),this.fields.get(e).getAdapter({initiator:this}).setMetaValue("disabled",s,{processChanges:!0})},dependsOn:i})}addVisibleWhenEffect(e,t,i){this.addDisableWhenEffect(e,(async()=>!await t()),i),this.effectManager.addEffect(s(e,"visible"),{type:"visible-when",callback:async()=>{const s=await t();return console.log(`[Effect.VisibleWhen] Field ${e} visible: `,s),this.fields.get(e).getAdapter({initiator:this}).setMetaValue("visible",s,{processChanges:!0})},dependsOn:[s(e,"disabled")]})}addComputedFieldEffect(e,t,s,i){this.fields.add(new g(e,t,{changeSet:this.changeSet,effectManager:this.effectManager})),this.effectManager.addEffect(e,{type:"computed-field",callback:async()=>{const t=await s();return console.log(`[Effect.ComputedField] Field ${e} value: `,t),this.fields.get(e).setValue(t,{initiator:this,processChanges:!0})},dependsOn:i})}addFieldAutofillEffect(e,t,i){this.effectManager.addDependency(e,s(e,"autofill")),this.effectManager.addEffect(s(e,"autofill"),{type:"field-autofill",callback:async()=>{const s=this.fields.get(e).getAdapter({initiator:this}),i=s.getMetaValue("dirty");if(s.setMetaValue("autofill",!i),i)return s.processChanges();const n=await t();return console.log(`[Effect.FieldAutofill] Field ${e} value: `,n),s.setMetaValue("autofill",0!==s.setValue(n).size),s.processChanges()},dependsOn:[s(e,"dirty"),...i]})}addSelectOptionsInitializerEffect(e,t,s,i){this.effectManager.addEffect(e,{type:"select-options-initializer",callback:async()=>{const i=await t(),n=await s(),a=this.getElement(e),l=this.fields.get(e).getAdapter({initiator:this}),r=l.getValue({disabledIsNull:!1});l.setValue(i.value),a.innerHTML="";for(const e of[i,...n]){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent,a.options.add(t)}return l.setValue(r),l.setMetaValue("disabled",0===n.length),l.setMetaValue("optionsInitialized",0!==n.length),l.processChanges()},dependsOn:i})}}e.Form=E}(e||(e={}));var i=window;for(var n in s)i[n]=s[n];s.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();