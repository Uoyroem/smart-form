(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Column:()=>L,ContextFormField:()=>M,DependencyGraph:()=>s,EffectManager:()=>n,Form:()=>F,FormChangesForRadioManager:()=>b,FormChangesForTriggerEffectsManager:()=>w,FormChangesManager:()=>T,FormField:()=>_,FormFieldArray:()=>V,FormFieldChangeSet:()=>y,FormFieldChangeType:()=>f,FormFieldChangesEvent:()=>m,FormFieldElementLinker:()=>v,FormFieldLinker:()=>S,FormFields:()=>C,FormType:()=>r,FormTypeBoolean:()=>c,FormTypeCheckbox:()=>g,FormTypeDate:()=>u,FormTypeElementStatus:()=>l,FormTypeNumber:()=>d,FormTypeObject:()=>E,FormTypeRadio:()=>h,FormTypeSelect:()=>p,FormTypeText:()=>o,Table:()=>A,getMetaDependencyKey:()=>i});class s{constructor(){this._keys=new Set,this._dependentMap=new Map,this._dependencyMap=new Map,this._addedDependencies=[],this._topologicalOrder=[]}getDependencies(){return this._addedDependencies}buildDependenciesMap(){this._dependentMap=new Map,this._dependencyMap=new Map,this._keys=new Set,this._topologicalOrder=[];const e=this.getDependencies();for(const[t,s]of e)this._keys.add(t),this._keys.add(s),this._dependentMap.has(t)||this._dependentMap.set(t,new Set),this._dependentMap.has(s)||this._dependentMap.set(s,new Set),this._dependencyMap.has(t)||this._dependencyMap.set(t,new Set),this._dependencyMap.has(s)||this._dependencyMap.set(s,new Set),this._dependentMap.get(t).add(s),this._dependencyMap.get(s).add(t);const t=new Map;for(const[e,s]of this._dependentMap)t.set(e,s.size);const s=[];for(const[e,n]of t)0===n&&s.push(e);for(;s.length>0;){const e=s.shift();this._topologicalOrder.push(e);for(const n of this._dependencyMap.get(e))t.set(n,t.get(n)-1),0===t.get(n)&&s.push(n)}if(this._topologicalOrder.length!==this._keys.size)throw new Error("There are cyclic dependencies")}addDependency(e,t){this._addedDependencies.push([e,t])}get keys(){return this._keys}get topologicalOrder(){return this._topologicalOrder}get dependentMap(){return this._dependentMap}get dependencyMap(){return this._dependencyMap}}class n extends s{_keyEffect=(()=>new Map)();constructor(){super(),this._keyEffect=new Map}getDependencies(){const e=[];for(const[t,s]of this._keyEffect)for(const n of s.dependsOn)e.push([t,n]);return super.getDependencies().concat(e)}addEffect(e,t){this._keyEffect.set(e,t)}async triggerEffects(){let{changedNames:e=null}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(const t of this.topologicalOrder){if(null!=e&&0===this.dependentMap.get(t).intersection(e).size)continue;const s=this._keyEffect.get(t);if(null!=s){const t=await s.callback();e&&t.forEach((t=>{e.add(t)}))}else e&&e.add(t)}}}function a(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;const s=new Set(Object.keys(e)),n=new Set(Object.keys(t));if(s.size!==n.size)return!1;for(const n of s)if(!a(e[n],t[n]))return!1;return!0}function i(e,t){return`${e}:${t}`}let l=function(e){return e.VALUE_SUCCESSFULLY_RECEIVED="value-successfully-received",e.VALUE_SET_SUCCESS="value-set-success",e.META_VALUE_SUCCESSFULLY_RECEIVED="meta-value-successfully-received",e.META_VALUE_SET_SUCCESS="meta-value-set-success",e.FAILED_TO_SET_VALUE="failed-to-set-value",e.FAILED_TO_SET_META_VALUE="failed-to-set-meta-value",e.INVALID_ELEMENT="invalid-element",e.TYPE_MISMATCH="type-mismatch",e.META_KEY_NOT_EXISTS="meta-key-not-exists",e}({});class r{static object(){return new E}static boolean(){return new c}static text(){return new o}static number(){return new d}static date(){return new u}static select(){let{multiple:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(new p).multiple(e)}static checkbox(){return new g}static radio(){return new h}static isFormElement(e){return e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement}static fromFormElement(e){switch(e.type){case"select-one":return this.select();case"select-multiple":return this.select().multiple();case"number":return this.number();case"text":return this.text();case"textarea":return this.text().area();case"checkbox":return this.checkbox();case"radio":return this.radio();case"date":return this.date();default:throw new Error(`As element type ${e} not has`)}}constructor(e){this.name=e}isEqual(e,t){return e===t}isEmpty(){}asElementType(){return"hidden"}fetch(){}getFieldValue(e){return e.getValue()}getFieldMetaValue(e,t){return e.getMetaValue(t)}setFieldValue(e,t){return e.setValue(t)}setFieldMetaValue(e,t,s){return e.setMetaValue(t,s)}getElementValue(e){return r.isFormElement(e)?e.type!==this.asElementType()?[null,l.TYPE_MISMATCH]:[e.value,l.VALUE_SUCCESSFULLY_RECEIVED]:[null,l.INVALID_ELEMENT]}setElementValue(e,t){return r.isFormElement(e)?e.type!==this.asElementType()?l.TYPE_MISMATCH:(e.value=t,l.VALUE_SET_SUCCESS):l.INVALID_ELEMENT}getElementMetaValue(e,t){return r.isFormElement(e)?e.type!==this.asElementType()?[void 0,l.TYPE_MISMATCH]:"disabled"===t?[e.disabled,l.META_VALUE_SUCCESSFULLY_RECEIVED]:[void 0,l.META_KEY_NOT_EXISTS]:[void 0,l.INVALID_ELEMENT]}setElementMetaValue(e,t,s){if(!r.isFormElement(e))return l.INVALID_ELEMENT;if(e.type!==this.asElementType())return l.TYPE_MISMATCH;if("disabled"===t)e.disabled=Boolean(s);else{if("autofill"!==t)return l.META_KEY_NOT_EXISTS;e.classList.toggle("autofill",Boolean(s))}return l.META_VALUE_SET_SUCCESS}getInitialValue(){return null}getInitialMeta(){const e=new Map;return e.set("disabled",{value:!1,resettable:!1}),e.set("dirty",{value:!1,resettable:!0}),e}isSameType(e){return this.name===e.name}}class o extends r{constructor(){super("String"),this._area=!1}area(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._area=e,this}asElementType(){return this._area?"textarea":"text"}}class d extends r{constructor(){super("Number")}asElementType(){return"number"}}class u extends r{constructor(){super("Date")}asElementType(){return"date"}isEqual(e,t){return e.toDateString()===t.toDateString()}}class c extends r{constructor(){super("Boolean")}}class h extends r{constructor(){super("Radio")}asElementType(){return"radio"}getInitialMeta(){const e=super.getInitialMeta();return e.set("checked",{value:!1,resettable:!0}),e}getFieldValue(e){return e.getMetaValue("checked")?e.getValue():null}setFieldValue(e,t){return e.setMetaValue("checked",null!=t&&e.getValue()===t)}getElementMetaValue(e,t){const[s,n]=super.getElementMetaValue(e,t);return n!==l.META_KEY_NOT_EXISTS?[s,n]:"checked"===t?[e.checked,l.META_VALUE_SUCCESSFULLY_RECEIVED]:[void 0,l.META_KEY_NOT_EXISTS]}setElementMetaValue(e,t,s){const n=super.setElementMetaValue(e,t,s);return n!==l.META_KEY_NOT_EXISTS?n:"checked"===t?(e.checked=Boolean(s),l.META_VALUE_SET_SUCCESS):l.META_KEY_NOT_EXISTS}}class g extends r{constructor(){super("Checkbox")}asElementType(){return"checkbox"}getInitialMeta(){const e=super.getInitialMeta();return e.set("checked",{value:!1,resettable:!0}),e}getFieldValue(e){const t=e.getValue();return["","on"].includes(t)?e.getMetaValue("checked"):e.getMetaValue("checked")?t:null}setFieldValue(e,t){return["","on"].includes(e.getValue())?e.setMetaValue("checked",t):e.setMetaValue("checked",null!=t&&e.getValue()===t)}getElementMetaValue(e,t){const[s,n]=super.getElementMetaValue(e,t);return n!==l.META_KEY_NOT_EXISTS?[s,n]:"checked"===t?[e.checked,l.META_VALUE_SUCCESSFULLY_RECEIVED]:[void 0,l.META_KEY_NOT_EXISTS]}setElementMetaValue(e,t,s){const n=super.setElementMetaValue(e,t,s);return n!==l.META_KEY_NOT_EXISTS?n:"checked"===t?(e.checked=Boolean(s),l.META_VALUE_SET_SUCCESS):l.META_KEY_NOT_EXISTS}}class p extends r{constructor(){super("select"),this._multiple=!1,this._of=r.text()}asElementType(){return this._multiple?"select-multiple":"select-one"}getInitialMeta(){const e=super.getInitialMeta();return e.set("options",{value:[],resettable:!1}),e}multiple(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._multiple=e,this}of(e){return this._of=e,this}getFieldValue(e){const t=e.getValue(),s=e.getMetaValue("options"),n=s.map((e=>e.value));return this._multiple?t.filter((e=>n.some((t=>t==e)))):n.some((e=>e==t))?t:s.find((e=>e.selected))?.value??s.find((e=>!e.disabled))?.value??null}setFieldValue(e,t){const s=e.getMetaValue("options"),n=s.map((e=>e.value)),a=this._multiple?Array.isArray(t)?t.filter((e=>n.some((t=>t==e)))):[]:n.some((e=>e==t))?t:s.find((e=>e.selected))?.value??s.find((e=>!e.disabled))?.value??null;return e.setValue(a)}getElementValue(e){return r.isFormElement(e)?e.type!==this.asElementType()?[void 0,l.TYPE_MISMATCH]:this._multiple?[Array.from(e.selectedOptions,(e=>e.value)),l.VALUE_SUCCESSFULLY_RECEIVED]:[e.value,l.VALUE_SUCCESSFULLY_RECEIVED]:[void 0,l.INVALID_ELEMENT]}getElementMetaValue(e,t){const[s,n]=super.getElementMetaValue(e,t);return n!==l.META_KEY_NOT_EXISTS?[s,n]:"options"===t?[Array.from(e.options,(e=>({value:e.value||e.textContent,disabled:e.disabled,selected:e.selected,textContent:e.textContent}))),l.META_VALUE_SUCCESSFULLY_RECEIVED]:[void 0,l.META_KEY_NOT_EXISTS]}setElementValue(e,t){return r.isFormElement(e)?e.type!==this.asElementType()?l.TYPE_MISMATCH:(Array.from(e.selectedOptions).forEach((e=>{e.selected=!1})),(this._multiple?t:[t]).map((t=>e.querySelector(`option[value="${t}"]`))).filter((e=>null!=e)).forEach((e=>{e.selected=!0})),l.VALUE_SET_SUCCESS):l.INVALID_ELEMENT}setElementMetaValue(e,t,s){const n=super.setElementMetaValue(e,t,s);if(n!==l.META_KEY_NOT_EXISTS)return n;if("options"===t){e.innerHTML="";for(const t of s){const s=document.createElement("option");s.value=t.value,s.disabled=t.disabled,s.selected=t.selected,s.textContent=t.textContent,e.options.add(s)}return l.META_VALUE_SET_SUCCESS}return l.META_KEY_NOT_EXISTS}}class E extends r{constructor(){super("Object")}isEqual(e,t){return a(e,t)}}let f=function(e){return e[e.Value=0]="Value",e[e.MetaValue=1]="MetaValue",e}({});class m extends Event{constructor(e){super("changes",{cancelable:!0}),this.changes=e}}class y{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:128;this._changes=[],this._maxSize=e}trimProcessedChanges(){for(;this._changes.length>this._maxSize;){const e=this._changes.findIndex((e=>e.processed));if(-1===e)break;this._changes.splice(e,1)}}add(e){let t=null;e.type===f.Value?t=this.getFieldChange(e.field,{type:f.Value}):e.type===f.MetaValue&&(t=this.getFieldChange(e.field,{type:f.MetaValue,metaKey:e.metaKey})),null!=t&&(t.last=!1),this._changes.push(e),this.trimProcessedChanges()}remove(e){this._changes.splice(this._changes.indexOf(e),1)}getFieldChange(e){let{onlyCurrentState:t=!0,last:s=!0,processed:n=!1,type:a=null,metaKey:i=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=this.getFieldChanges(e,{onlyCurrentState:t,last:s,processed:n,type:a});return a===f.MetaValue&&null!=i&&(l=l.filter((e=>e.metaKey===i))),l.at(-1)}getFieldChanges(e){let{onlyCurrentState:t=!0,last:s=!0,processed:n=!1,type:a=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this._changes.filter((t=>t.field===e));return null!=a&&(i=i.filter((e=>e.type===a))),null!=s&&(i=i.filter((e=>e.last===s))),null!=n&&(i=i.filter((e=>e.processed===n))),t&&(i=i.filter((t=>t.stateKey===e.currentStateKey))),i}hasChanges(e){return 0!==this.getFieldChanges(e,{onlyCurrentState:!0,last:!0}).length}markProcessed(e){e.forEach((e=>{e.processed=!0})),this.trimProcessedChanges()}static asChangedName(e){return e.type===f.Value?e.field.name:e.type===f.MetaValue?i(e.field.name,e.metaKey):null}static asChangedNames(e){const t=new Set;for(const s of e){const e=this.asChangedName(s);null!=e&&t.add(e)}return t}processChanges(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=this.getFieldChanges(e,{onlyCurrentState:!0,type:t});return s||(this.markProcessed(this.getFieldChanges(e,{onlyCurrentState:!0,last:null,type:t})),e.dispatchEvent(new m(n))),y.asChangedNames(n)}}class _ extends EventTarget{constructor(e,t){let{changeSet:s=null,effectManager:n=null}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this._name=e,this._type=t,this._initializedStateKeys=new Set,this._initialValue=this.type.getInitialValue(),this._valueMap=new Map,this._initialMeta=this.type.getInitialMeta(),this._metaMap=new Map,this._changeSet=s??new y(32),this._currentStateKey="default",this.initializeState({stateKey:"default"}),null!=n&&this.initializeDependencies(n)}get self(){return this}get currentStateKey(){return this._currentStateKey}get context(){return{disabledIsNull:!0,initiator:null,stateKey:null,raw:!1,processChanges:!1}}get changeSet(){return this._changeSet}get name(){return this._name}get type(){return this._type}clearInitialMeta(){this._initialMeta=new Map}reset(){let{stateKey:e=null,initiator:t=null,processChanges:s=!1,full:n=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e??=this._currentStateKey,console.log("[FormField.reset] Reset state `%s` for field `%s`",e,this.name),this.setValue(this._initialValue,{raw:!0,stateKey:e,initiator:t}),n&&this._metaMap.set(e,new Map);for(const[s,a]of this._initialMeta.entries())(n||a.resettable)&&this.setMetaValue(s,a.value,{raw:!0,stateKey:e,initiator:t});return this.processChanges(null,!s)}initializeState(e){let{stateKey:t,initiator:s=null}=e;this._initializedStateKeys.has(t)||(console.log("[FormField.initializeState] Initializing state key `%s` for field `%s`",t,this.name),this._initializedStateKeys.add(t),this.reset({stateKey:t,initiator:s,processChanges:!0,full:!0}))}switchState(e){let{stateKey:t,initiator:s=null,processChanges:n=!1}=e;console.log("[FormField.switchState] Switching state for field `%s` from `%s` to `%s`",this.name,this._currentStateKey,t),this.initializeState({stateKey:t,initiator:s});const a=this._valueMap.get(this._currentStateKey),i=this._valueMap.get(t);if(!this.type.isEqual(a,i)){const e={stateKey:t,type:f.Value,field:this,initiator:s,oldValue:a,newValue:i,date:new Date,last:!0,processed:!1};this.changeSet.add(e)}for(const[e,n]of this._metaMap.get(t).entries()){const a=this._metaMap.get(this._currentStateKey).get(e);if(a!==n){const i={stateKey:t,type:f.MetaValue,field:this,initiator:s,metaKey:e,oldValue:a,newValue:n,date:new Date,last:!0,processed:!1};this.changeSet.add(i)}}return this._currentStateKey=t,this.processChanges(null,!n)}initializeDependencies(e){switch(e.addDependency(this.name,i(this.name,"disabled")),this.type.asElementType()){case"checkbox":case"radio":e.addDependency(this.name,i(this.name,"checked"))}}getAdapter(e){return new Proxy(this,{get(t,s,n){switch(s){case"self":return t;case"context":return e;case"getAdapter":return function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.getAdapter({...e,...s})};case"getValue":return function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.getValue({...e,...s})};case"getMetaValue":return function(s){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.getMetaValue(s,{...e,...n})};case"setValue":return function(s){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.setValue(s,{...e,...n})};case"setMetaValue":return function(s,n){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.setMetaValue(s,n,{...e,...a})};default:const a=Reflect.get(t,s,n);return"function"==typeof a?a.bind(t):a}}})}getValue(){let{stateKey:e=null,raw:t=!1,disabledIsNull:s=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t?(e??=this._currentStateKey,this.initializeState({stateKey:e}),this._valueMap.get(e)):s&&this.getMetaValue("disabled",{stateKey:e})?null:this.type.getFieldValue(this.getAdapter({stateKey:e,raw:!0}))}setInitialValue(e){this._initialValue=e}setValue(e){let{stateKey:t=null,raw:s=!1,initiator:n=null,processChanges:a=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!s)return this.type.setFieldValue(this.getAdapter({stateKey:t,raw:!0,processChanges:a,initiator:n}),e);n??=this,t??=this._currentStateKey,this.initializeState({stateKey:t,initiator:n});const i=this.getValue({stateKey:t,raw:!0});if(this.type.isEqual(i,e))return new Set;this._valueMap.set(t,e);const l={stateKey:t,type:f.Value,field:this,initiator:n,oldValue:i,newValue:e,date:new Date,last:!0,processed:!1};return console.log("[FormField.setValue] Value changed:",{oldValue:i,newValue:e,stateKey:t}),this.changeSet.add(l),this.processChanges(f.Value,!a)}getMetaValue(e){let{stateKey:t=null,raw:s=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s?(t??=this._currentStateKey,this.initializeState({stateKey:t}),this._metaMap.get(t).get(e)):this.type.getFieldMetaValue(this.getAdapter({raw:!0,stateKey:t}),e)}setInitialMetaValue(e,t){let{resettable:s=!0}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._initialMeta.set(e,{value:t,resettable:s})}setMetaValue(e,t){let{stateKey:s=null,initiator:n=null,processChanges:a=!1,raw:l=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!l)return this.type.setFieldMetaValue(this.getAdapter({stateKey:s,raw:!0,initiator:n,processChanges:a}),e,t);n??=this,s??=this._currentStateKey,this.initializeState({stateKey:s,initiator:n});const r=this.getMetaValue(e,{stateKey:s});if(r===t)return new Set;this._metaMap.get(s).set(e,t);const o={stateKey:s,type:f.MetaValue,field:this,initiator:n,metaKey:e,oldValue:r,newValue:t,date:new Date,last:!0,processed:!1};return this.changeSet.add(o),console.log("[FormField.setMetaValue] Meta",i(this.name,e),"value changed:",{oldValue:r,newValue:t,stateKey:s}),this.processChanges(f.MetaValue,!a)}processChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.changeSet.processChanges(this,e,t)}}class M{constructor(e,t){this.field=e,this.context=t}}class V{constructor(e){this.fieldArray=e}getAdapter(e){return new Proxy(this,{get(t,s,n){switch(s){case"self":return t;case"context":return e;case"getAdapter":return function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.getAdapter({...e,...s})};case"getValue":return function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.getValue({...e,...s})};case"getMetaValue":return function(s){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.getMetaValue(s,{...e,...n})};case"setValue":return function(s){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.setValue(s,{...e,...n})};case"setMetaValue":return function(s,n){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.setMetaValue(s,n,{...e,...a})};default:const a=Reflect.get(t,s,n);return"function"==typeof a?a.bind(t):a}}})}getValue(){let{stateKey:e=null,disabledIsNull:t=!0,raw:s=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.fieldArray.map((n=>n.getValue({stateKey:e,disabledIsNull:t,raw:s}))).find((e=>null!=e))}getMetaValue(e){let{stateKey:t=null,raw:s=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.fieldArray.map((n=>n.getMetaValue(e,{stateKey:t,raw:s}))).find((e=>null!=e))}setValue(e){let{stateKey:t=null,initiator:s=null,processChanges:n=!1,raw:a=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.fieldArray.map((i=>i.setValue(e,{stateKey:t,initiator:s,processChanges:n,raw:a}))).find((e=>0!==e.size))??new Set}setMetaValue(e,t){let{stateKey:s=null,initiator:n=null,processChanges:a=!1,raw:i=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.fieldArray.map((l=>l.setMetaValue(e,t,{stateKey:s,initiator:n,processChanges:a,raw:i}))).find((e=>0!==e.size))??new Set}processChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.fieldArray.map((s=>s.processChanges(e,t))).find((e=>0!==e.size))??new Set}}class S{constructor(e){this.field=e,this.type=e.type}}class v extends S{constructor(e,t){if(super(e),this.element=t,this.type.asElementType()!==this.element.type)throw new Error("For link type is equal");this._fieldChangesEventListener=this._fieldChangesEventListener.bind(this),this._elementValueInputEventListener=this._elementValueInputEventListener.bind(this),this._elementValueChangeEventListener=this._elementValueChangeEventListener.bind(this),this._handleHideContainer=null}link(){this.field.setInitialValue(this._getElementValue()),this.field.setInitialMetaValue("disabled",this._getElementMetaValue("disabled"),{resettable:!1}),this.field.setInitialMetaValue("container",this.element.parentElement,{resettable:!1}),["radio","checkbox"].includes(this.type.asElementType())&&this.field.setInitialMetaValue("checked",this._getElementMetaValue("checked")),["select-one","select-multiple"].includes(this.type.asElementType())&&this.field.setInitialMetaValue("options",this._getElementMetaValue("options"),{resettable:!1}),this.field.reset({processChanges:!0,initiator:this,full:!0}),this.field.addEventListener("changes",this._fieldChangesEventListener),["text","number","textarea"].includes(this.type.asElementType())?this.element.addEventListener("input",this._elementValueInputEventListener):this.element.addEventListener("change",this._elementValueChangeEventListener)}unlink(){this.field.removeEventListener("changes",this._fieldChangesEventListener),["text","number","textarea"].includes(this.type.asElementType())?this.element.removeEventListener("input",this._elementValueInputEventListener):this.element.removeEventListener("change",this._elementValueChangeEventListener)}_elementValueInputEventListener(e){console.log("[FormFieldElementLinker._elementValueInputEventListener] Event"),this.field.setMetaValue("dirty",!0,{initiator:this,processChanges:!0}),this._syncFieldValue()}_elementValueChangeEventListener(e){this.field.setMetaValue("dirty",!0,{initiator:this,processChanges:!0}),["radio","checkbox"].includes(this.type.asElementType())?this._syncFieldMetaValue("checked"):this._syncFieldValue()}_fieldChangesEventListener(e){const t=e.changes.filter((e=>e.initiator!==this));for(const e of t)e.type===f.Value?this._syncElementValue():e.type===f.MetaValue&&this._syncElementMetaValue(e.metaKey)}_syncElementValue(){console.log("[FormFieldElementLinker._syncElementValue] Syncing element value");const e=this.field.getValue({raw:!0}),t=this.type.setElementValue(this.element,e);t===l.VALUE_SET_SUCCESS||console.log("[FormFieldElementLinker._syncElementMetaValue] Failed to set element value, status `%s`",t)}_getElementValue(){const[e,t]=this.type.getElementValue(this.element);return t!==l.VALUE_SUCCESSFULLY_RECEIVED&&console.warn("[FormFieldElementLinker._getElementValue] Failed to get value from element, status `%s`",t),e}_syncFieldValue(){console.log("[FormFieldElementLinker._syncFieldValue] Syncing field value"),this.field.setValue(this._getElementValue(),{initiator:this,processChanges:!0,raw:!0})}_syncElementMetaValue(e){console.log("[FormFieldElementLinker._syncElementMetaValue] Syncing element meta value");const t=this.field.getMetaValue(e,{raw:!0}),s=this.type.setElementMetaValue(this.element,e,t);if(s!==l.META_VALUE_SET_SUCCESS)if(s!==l.META_KEY_NOT_EXISTS)console.log("[FormFieldElementLinker._syncElementMetaValue] Failed to set element meta value, status `%s`",s);else switch(e){case"visible":const e=this.field.getMetaValue("container");null!=this._handleHideContainer&&(e.removeEventListener("transitionend",this._handleHideContainer),this._handleHideContainer=null),t?"none"===e.style.display?(e.style.display="",requestAnimationFrame((()=>{e.dataset.visible="true"}))):e.dataset.visible="true":("none"!==e.style.display&&(this._handleHideContainer=t=>{e.style.display="none"},e.addEventListener("transitionend",this._handleHideContainer,{once:!0})),e.dataset.visible="false");break;case"options":0!==t.length&&this._syncElementValue()}}_getElementMetaValue(e){const[t,s]=this.type.getElementMetaValue(this.element,e);return s!==l.META_VALUE_SUCCESSFULLY_RECEIVED&&console.warn("[FormFieldElementLinker._getElementMetaValue] Failed to get value from element, status `%s`",s),t}_syncFieldMetaValue(e){console.log("[FormFieldElementLinker._syncFieldMeta] Syncing field meta value"),this.field.setMetaValue(e,this._getElementMetaValue(e),{initiator:this,processChanges:!0})}}class C extends EventTarget{constructor(){super(),this.list=[],this._fieldChangesEventListener=this._fieldChangesEventListener.bind(this)}_fieldChangesEventListener(e){this.dispatchEvent(new m(e.changes))}add(e){return e=e.self,!this.list.includes(e)&&(e.addEventListener("changes",this._fieldChangesEventListener),this.list.push(e),!0)}remove(e){return e=e.self,!!this.list.includes(e)&&(e.removeEventListener("changes",this._fieldChangesEventListener),this.list.splice(this.list.indexOf(e),1),!0)}get(e){const t=this.list.filter((t=>t.name===e));return 1===t.length?t[0]:new V(t)}[Symbol.iterator](){return new Set(this.list.map((e=>e.name))).values()}}class T{}class b extends T{manage(e,t){t.filter((t=>t.initiator!==e&&"radio"===t.field.type.asElementType()&&t.type===f.MetaValue&&"checked"===t.metaKey&&t.newValue)).forEach((t=>{e.fields.list.filter((e=>e.name===t.field.name&&"radio"===e.type.asElementType()&&e!=t.field&&e.getMetaValue("checked"))).forEach((t=>{t.setMetaValue("checked",!1,{initiator:e,processChanges:!0})}))}))}}class w extends T{manage(e,t){0!==(t=t.filter((t=>t.initiator!==e))).length&&e.effectManager.triggerEffects({changedNames:y.asChangedNames(t)})}}class F extends EventTarget{constructor(e){let{form:t}=e;super(),this.form=t,this.changeSet=new y,this.effectManager=new n,this.fields=new C,this.fieldLinkers=[],this._changesManagers=[],this._handleChanges=this._handleChanges.bind(this)}async setup(){null!=this.form&&(this.form.classList.add("ss-form"),this.form.addEventListener("submit",(e=>{e.preventDefault(),this.submit().then((()=>this.reset()))})),this.form.addEventListener("reset",(e=>{e.preventDefault(),this.reset()})),this.fields.addEventListener("changes",this._handleChanges),this.registerChangesManager(new b),this.registerChangesManager(new w),this.registerElements())}_handleChanges(e){const t=e.changes;for(const e of this._changesManagers)e.manage(this,t)}switchState(e){for(const t of this.fields.list)t.switchState({stateKey:e,initiator:this,processChanges:!0});this.effectManager.triggerEffects()}registerChangesManager(e){this._changesManagers.push(e)}getFormData(){const e={};for(const t of this.fields)e[t]=this.fields.get(t).getValue();return e}updateFormData(e){for(const t of this.fields)t in e&&this.fields.get(t).setValue(e[t],{initiator:this});this.effectManager.triggerEffects()}registerElements(){for(const e of this.form.elements){if(!r.isFormElement(e))continue;if(""===e.name)continue;const t=new _(e.name,r.fromFormElement(e),{changeSet:this.changeSet,effectManager:this.effectManager}),s=new v(t,e);s.link(),this.fieldLinkers.push(s),this.fields.add(t)}}getElement(e){return this.form.elements.namedItem(e)}async submit(){}reset(){for(const e of this.fields.list)e.reset({initiator:this});this.effectManager.triggerEffects()}addDisableWhenEffect(e,t,s){this.effectManager.addEffect(i(e,"disabled"),{type:"disable-when",callback:async()=>{const s=await t();return this.fields.get(e).getAdapter({initiator:this}).setMetaValue("disabled",s,{processChanges:!0})},dependsOn:s})}addVisibleWhenEffect(e,t,s){this.addDisableWhenEffect(e,(async()=>!await t()),s),this.effectManager.addEffect(i(e,"visible"),{type:"visible-when",callback:async()=>{const s=await t();return this.fields.get(e).getAdapter({initiator:this}).setMetaValue("visible",s,{processChanges:!0})},dependsOn:[i(e,"disabled")]})}addComputedFieldEffect(e,t,s,n){this.fields.add(new _(e,t,{changeSet:this.changeSet,effectManager:this.effectManager})),this.effectManager.addEffect(e,{type:"computed-field",callback:async()=>{const t=await s();return this.fields.get(e).setValue(t,{initiator:this,processChanges:!0})},dependsOn:n})}addFieldAutofillEffect(e,t,s){this.effectManager.addDependency(e,i(e,"autofill")),this.effectManager.addEffect(i(e,"autofill"),{type:"field-autofill",callback:async()=>{const s=this.fields.get(e).getAdapter({initiator:this}),n=s.getMetaValue("dirty");if(s.setMetaValue("autofill",!n),n)return s.processChanges();const a=await t();return s.setMetaValue("autofill",0!==s.setValue(a).size),s.processChanges()},dependsOn:[i(e,"dirty"),...s]})}addSelectOptionsInitializerEffect(e,t,s,n){this.effectManager.addDependency(i(e,"disabled"),i(e,"options")),this.effectManager.addEffect(i(e,"options"),{type:"select-options-initializer",callback:async()=>{const n=await t(),a=await s(),i=this.fields.get(e).getAdapter({initiator:this}),l=i.getValue({disabledIsNull:!1});return i.setValue(l),i.setMetaValue("disabled",0===a.length),i.setMetaValue("options",[n,...a]),i.processChanges()},dependsOn:n})}}class L{}class A{constructor(e){let{container:t,columnDefinitions:s}=e;this.container=t,this.columnDefinitions=s,this.render()}async render(){const e=document.createElement("div");e.innerHTML='\n            <div class="ss-table">\n                <div class="ss-table-head">\n                    <div class="ss-table-row">\n                        <div class="ss-table-header-columns-pinned-left">\n                        </div>\n                        <div class="ss-table-header-columns">\n                            \n                        </div>\n                        <div class="ss-table-header-columns-pinned-right">\n                        </div>\n                    </div>\n                </div>\n                <div class="ss-table-body">\n                    <div class="ss-table-body-row-columns-pinned-left">\n                        \n                    </div>\n                    <div class="ss-table-body-rows">\n                        <div class="ss-table-body-row">\n                            <div class="ss-table-body-cell">\n                            </div>\n                        </div>\n                    </div>\n                    <div class="ss-table-body-row-columns-pinned-right">\n                    </div>\n                </div>\n                <div class="ss-table-footer">\n                    <div class="ss-table-footer-row-columns-pinned-left">\n                    </div>\n                    <div class="ss-table-footer-rows">\n                        <div class="ss-table-footer-row">\n                        </div>\n                    </div>\n                    <div class="ss-table-footer-row-columns-pinned-left">\n                    </div>\n                </div>\n            </div>\n        ';const t=e.querySelector(".ss-table-header-columns");for(const e of this.columnDefinitions){const s=document.createElement("div");s.classList.add("ss-table-cell"),s.classList.add("ss-table-header-column"),s.textContent=e.title,t.append(s)}this.container.innerHTML="",this.container.append(e)}}window.SmartSystem=t})();
//# sourceMappingURL=smart-system.bundle.min.js.map